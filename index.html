<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SOUS List</title>
<style>
body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #f4f4f8; transition: background 0.3s, color 0.3s; }
header { background: #222; color: #fff; padding: 1em; text-align: center; }
nav { display: flex; justify-content: center; background: #333; }
nav button { background: none; border: none; color: #fff; padding: 1em; cursor: pointer; }
nav button.active { background: #555; }
.container { padding: 1em; max-width: 900px; margin: auto; }
.card { background: white; padding: 1em; border-radius: 8px; margin-bottom: 1em; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: background 0.3s, color 0.3s; }

/* Dark mode styles */
body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
body.dark-mode header { background: #111; }
body.dark-mode nav { background: #222; }
body.dark-mode nav button.active { background: #444; }
body.dark-mode .card { background: #2a2a2a; color: #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #333; color: #e0e0e0; border: 1px solid #444; }
body.dark-mode pre { background: #333; color: #e0e0e0; }
body.dark-mode .filterable-dropdown-content { background-color: #333; border-color: #444; }
body.dark-mode .filterable-dropdown-content div { border-bottom-color: #444; }
body.dark-mode .filterable-dropdown-content div:hover { background-color: #444; }
body.dark-mode .ingredient-name-dropdown-content { background-color: #333; border-color: #444; }
body.dark-mode .ingredient-name-dropdown-content div { border-bottom-color: #444; }
body.dark-mode .ingredient-name-dropdown-content div:hover { background-color: #444; }

label { display: block; margin-top: 0.5em; font-weight: bold; }
input, select, textarea { 
    width: 100%; 
    padding: 0.5em; 
    margin-top: 0.25em; 
    box-sizing: border-box; /* Important for width */
}
button { margin-top: 0.5em; padding: 0.5em 1em; border-radius: 5px; border: none; cursor: pointer; }
button.save { background: #4caf50; color: white; }
button.delete { background: #f44336; color: white; }
button.export { background: #2196f3; color: white; }
button.secondary { background: #777; color: white; }
button.blue { background: #2196f3; color: white; }
button.purple { background: #9c27b0; color: white; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1em; }
pre { background: #eee; padding: 1em; white-space: pre-wrap; word-wrap: break-word; border-radius: 5px; }
textarea { resize: vertical; }

/* Markdown preview styles */
#markdown-preview {
  padding: 1em;
  border: 1px solid #ddd;
  border-radius: 5px;
  background: #fff;
}
#markdown-preview h1 {
  font-size: 1.8em;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.3em;
}
#markdown-preview h2 {
  font-size: 1.3em;
  margin-top: 1em;
  margin-bottom: 0.5em;
  color: #333;
}
#markdown-preview ul {
  list-style-type: none;
  padding-left: 0;
}
#markdown-preview li {
  margin-bottom: 0.5em;
  padding-left: 0;
  position: relative;
  display: flex;
  align-items: flex-start;
  gap: 0.5em;
}
#markdown-preview li:before {
  content: none;
}
#markdown-preview li input[type="checkbox"] {
  margin-top: 0.2em;
  width: auto;
  cursor: pointer;
  flex-shrink: 0;
}
#markdown-preview p {
  margin: 0.5em 0;
  font-style: italic;
  color: #666;
}
body.dark-mode #markdown-preview {
  background: #2a2a2a;
  border-color: #444;
  color: #e0e0e0;
}
body.dark-mode #markdown-preview h1 {
  border-bottom-color: #555;
}
body.dark-mode #markdown-preview h2 {
  color: #e0e0e0;
}
body.dark-mode #markdown-preview p {
  color: #999;
}
body.dark-mode pre {
  background: #333;
  color: #e0e0e0;
}

/* Green checkboxes when checked */
input[type="checkbox"]:checked {
  accent-color: #4caf50;
}

/* Toggle switch styles */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 24px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider {
  background-color: #4caf50;
}
.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(26px);
}
body.dark-mode .toggle-slider {
  background-color: #555;
}
body.dark-mode .toggle-switch input:checked + .toggle-slider {
  background-color: #4caf50;
}

/* Item box styles */
.item-box {
  background: #f9f9f9;
  border-radius: 5px;
}
body.dark-mode .item-box {
  background: #333;
}

/* Drag and drop styles */
.draggable-item {
  display: flex;
  align-items: center;
  gap: 0.5em;
  padding: 0.5em;
  margin-bottom: 0.5em;
  background: #f9f9f9;
  border-radius: 4px;
  cursor: move;
  border: 1px solid #ddd;
}
.draggable-item:hover {
  background: #f0f0f0;
}
.draggable-item.dragging {
  opacity: 0.5;
}
.drag-handle {
  cursor: grab;
  font-size: 1.2em;
  color: #999;
}
.drag-handle:active {
  cursor: grabbing;
}
body.dark-mode .draggable-item {
  background: #333;
  border-color: #444;
}
body.dark-mode .draggable-item:hover {
  background: #3a3a3a;
}

/* Filterable dropdown styles */
.filterable-dropdown {
  position: relative;
  width: 100%;
}
.filterable-dropdown input[type="text"] {
  width: 100%;
  padding: 0.5em;
  box-sizing: border-box;
  cursor: pointer;
}
.filterable-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  width: 100%;
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-top: none;
  z-index: 1000;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.filterable-dropdown-content div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
.filterable-dropdown-content div:hover {
  background-color: #f1f1f1;
}
.filterable-dropdown-content div.no-results {
  color: #999;
  cursor: default;
}
.filterable-dropdown-content div.no-results:hover {
  background-color: white;
}

/* Collapsible section styles */
.collapsible-header {
  display: flex;
  align-items: center;
  gap: 0.5em;
  cursor: pointer;
  user-select: none;
}
.collapsible-header:hover {
  opacity: 0.8;
}
.collapsible-arrow {
  font-size: 1.2em;
  font-weight: bold;
}
.collapsible-content {
  display: none;
  margin-top: 1em;
}
.collapsible-content.show {
  display: block;
}

/* New styles for ingredient rows */
.ingredient-row {
    display: grid;
    grid-template-columns: 3fr 2fr 1fr 1fr 1fr;
    gap: 0.5em;
    align-items: center;
    margin-bottom: 0.5em;
    position: relative;
}

/* Ingredient name dropdown styles */
.ingredient-name-dropdown {
  position: relative;
  width: 100%;
}
.ingredient-name-dropdown input[type="text"] {
  width: 100%;
  padding: 0.5em;
  box-sizing: border-box;
}
.ingredient-name-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-top: none;
  z-index: 1000;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.ingredient-name-dropdown-content div {
  padding: 8px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  font-size: 0.9em;
}
.ingredient-name-dropdown-content div:hover {
  background-color: #f1f1f1;
}
.ingredient-name-dropdown-content div.no-results {
  color: #999;
  cursor: default;
}
.ingredient-name-dropdown-content div.no-results:hover {
  background-color: white;
}

.ingredient-row label {
    margin: 0;
    font-size: 0.8em;
}
.ingredient-row input, .ingredient-row select {
    margin: 0;
}
.ingredient-row button.delete {
    padding: 0.5em;
    margin: 0;
}

/* Planner day controls */
.day-controls {
    display: flex;
    gap: 0.5em;
    margin-bottom: 1em;
}
.day-controls button {
    font-size: 1.2em;
    padding: 0 0.75em;
    margin: 0;
}
</style>
</head>
<body>
<header><h1>üçΩÔ∏è Simplified Order Utility for a Shopping List (SOUS List)</h1></header>
<nav>
  <button id="tab-planner" class="active">Weekly Planner</button>
  <button id="tab-dictionary">Dinner Dictionary</button>
  <button id="tab-settings">Settings</button>
</nav>

<div class="container">
  <section id="dictionary" style="display:none;">
    <div class="card">
      <h2>Add / Edit Dinner</h2>
      <label>Title <input id="meal-title" placeholder="e.g. Taco Salad & Quesadillas" /></label>
      <label>Cooking Method <input id="meal-method" placeholder="e.g. Griddle, Oven, Slow Cooker, Grill/Griddle" /></label>
      
      <label>Ingredients</label>
      <div id="ingredient-rows">
        </div>
      <button class="secondary" id="add-ingredient-row-btn">+ Add Ingredient</button>
      
      <hr style="margin: 1.5em 0;">
      <button class="save" id="save-meal-btn">Save Meal</button>
      <button class="secondary" id="cancel-edit-btn" style="display:none;">Cancel</button>
      <input type="hidden" id="edit-meal-index">
    </div>
    
    <hr style="margin: 2em 0;">
    
    <div class="card">
      <h2>My Meals</h2>
      <label>Search/Filter Meals
        <input type="text" id="meal-search" placeholder="Search by meal name, ingredient, or cooking method...">
      </label>
      <label>Sort By
        <select id="meal-sort">
          <option value="name">Name (A-Z)</option>
          <option value="method">Cooking Method</option>
          <option value="ingredients">Ingredient Count</option>
        </select>
      </label>
    </div>
    
    <div id="meal-list" class="grid"></div>
  </section>

  <section id="planner">
    <div class="card">
      <h2>Weekly Meal Plan</h2>
      <div class="day-controls">
        <button id="start-new-week-btn" class="secondary" title="Clear all meals and start fresh">Start New Week</button>
      </div>
      <div id="week-slots"></div>
    </div>

    <div class="card">
      <div class="collapsible-header" id="quick-add-header">
        <span class="collapsible-arrow">‚ñº</span>
        <h2 style="margin: 0;">Quick Add Item</h2>
      </div>
      <div id="quick-add-content" class="collapsible-content">
        <p>Add ingredients from your Dinner Dictionary</p>
        <label>Select Item
          <div class="filterable-dropdown">
            <input type="text" id="quick-add-ingredient-input" placeholder="Type to search items..." autocomplete="off">
            <div id="quick-add-dropdown-content" class="filterable-dropdown-content"></div>
          </div>
        </label>
        <label>Notes (optional)
          <input type="text" id="quick-add-notes" placeholder="e.g. 3 bags, need 2 lbs">
        </label>
        <label>Quantity (optional)
          <input type="text" id="quick-add-qty" placeholder="e.g. 2, 3 bags, 1 lb">
        </label>
        <label style="display: flex; align-items: center; gap: 0.5em;">
          <input type="checkbox" id="quick-add-have">
          <span>Already Have This Item</span>
        </label>
        <button class="save" id="quick-add-btn">Add to Shopping List</button>
      </div>
    </div>

    <div class="card">
      <div class="collapsible-header" id="custom-item-header">
        <span class="collapsible-arrow">‚ñº</span>
        <h2 style="margin: 0;">New Custom Item</h2>
      </div>
      <div id="custom-item-content" class="collapsible-content">
        <p>Add items not in your Dinner Dictionary</p>
        <label>Item Name
          <input type="text" id="custom-item-name" placeholder="e.g. Paper Towels">
        </label>
        <label>Category
          <select id="custom-item-category"></select>
        </label>
        <label>Aisle (optional)
          <input type="text" id="custom-item-aisle" placeholder="e.g. 7">
        </label>
        <label>Quantity (optional)
          <input type="text" id="custom-item-qty" placeholder="e.g. 2, 3 bags, 1 lb">
        </label>
        <label>Notes (optional)
          <input type="text" id="custom-item-notes" placeholder="e.g. need 2 packs">
        </label>
        <label style="display: flex; align-items: center; gap: 0.5em;">
          <input type="checkbox" id="custom-item-have">
          <span>Already Have This Item</span>
        </label>
        <button class="save" id="custom-item-btn">Add to Shopping List</button>
      </div>
    </div>

    <div class="card">
      <h2>One-Off Items</h2>
      <div id="oneoff-items-list"></div>
    </div>

    <div class="card">
      <h2>Shopping List</h2>
      <p>Generate your consolidated markdown shopping list</p>
      <button class="export" id="generate-markdown-btn">Generate Markdown Shopping List</button>
      <button class="blue" id="copy-markdown-btn" style="display:none;">Copy to Clipboard</button>
      <div id="preview-toggle-container" style="display:none; margin-top: 1em;">
        <label style="display: flex; align-items: center; gap: 1em;">
          <span>Preview Mode</span>
          <label class="toggle-switch">
            <input type="checkbox" id="preview-mode-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span id="preview-mode-label">Code</span>
        </label>
      </div>
      <pre id="markdown-output"></pre>
      <div id="markdown-preview" style="display:none;"></div>
    </div>
  </section>

  <section id="settings" style="display:none;">
    <div class="card">
      <h2>About SOUS List</h2>
      <p><strong>Simplified Order Utility for a Shopping List</strong></p>
      <p><strong>Version:</strong> v1.5</p>
      <p><strong>Release Date:</strong> November 2, 2025</p>
    </div>

    <div class="card">
      <h2>Options</h2>
      <label style="display: flex; align-items: center; gap: 1em; margin-bottom: 0.5em;">
        <span>Include 'Have' Items in List</span>
        <label class="toggle-switch">
          <input type="checkbox" id="include-have-items-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </label>
      <small style="color: #666;">When enabled, items marked as "Have" appear as ‚úÖ. When disabled, they are excluded from the markdown list.</small>
    </div>

    <div class="card">
      <h2>Appearance</h2>
      <label style="display: flex; align-items: center; gap: 1em;">
        <span>Dark Mode</span>
        <label class="toggle-switch">
          <input type="checkbox" id="dark-mode-toggle">
          <span class="toggle-slider"></span>
        </label>
      </label>
    </div>

    <div class="card">
      <h2>Import / Export Data</h2>
      <label>Export Version (optional)
        <input type="text" id="export-version" placeholder="e.g. v1, family-mealplan, Holidays">
      </label>
      <button class="export" id="export-btn">Export JSON</button>
      <label>Import JSON
        <input type="file" id="import-file" accept=".json" />
      </label>
    </div>

    <div class="card">
      <h2>Manage Categories</h2>
      <p>Customize your grocery categories</p>
      <div id="categories-list"></div>
      <hr style="margin: 1em 0;">
      <label>Add New Category
        <input type="text" id="new-category-input" placeholder="e.g. Dairy, Meat, Bakery">
      </label>
      <button class="save" id="add-category-btn">Add Category</button>
    </div>

    <div class="card">
      <h2>Manage Items</h2>
      <p>Review and manage all ingredients/items in your meals</p>
      <label>Search Items
        <input type="text" id="items-search" placeholder="Search by item name...">
      </label>
      <label>Sort By
        <select id="items-sort">
          <option value="name">Name (A-Z)</option>
          <option value="usage-high">Usage Count (High to Low)</option>
          <option value="usage-low">Usage Count (Low to High)</option>
        </select>
      </label>
      <div id="items-list" style="margin-top: 1em;"></div>
    </div>

    <div class="card">
      <h2>Reset Application</h2>
      <button class="delete" id="reset-btn">Clear All Data (Reset)</button>
    </div>
  </section>
</div>

<script>
// --- DATA & STATE ---

const DEFAULT_CATEGORIES = ['Boxes/aisles', 'Frozen', 'Chilled - Dairy', 'Chilled - Meat', 'Produce', 'Produce - Refrigerated', 'Breads', 'Spices', 'Side Aisle (e.g., Medicine)'];
let CATEGORIES = JSON.parse(localStorage.getItem("categories") || "null") || DEFAULT_CATEGORIES;
const DAY_LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

const defaultMeals = [
  { 
    title: "Taco Salad & Quesadillas", 
    method: "Griddle", 
    ingredients: [
        { name: "Bags of Chips", category: "Boxes/aisles", aisle: "", qty: "3" },
        { name: "Shredded Cheese", category: "Chilled - Dairy", aisle: "", qty: "16 oz" },
        { name: "Lettuce", category: "Produce - Refrigerated", aisle: "", qty: "1 bag" },
        { name: "Ground Beef", category: "Chilled - Meat", aisle: "", qty: "3 lbs" },
        { name: "Catalina Dressing", category: "Boxes/aisles", aisle: "", qty: "1 Bottle" },
        { name: "Mexican/Spanish Rice", category: "Boxes/aisles", aisle: "", qty: "1 Box" },
        { name: "Refried Beans", category: "Boxes/aisles", aisle: "", qty: "1 Can" },
        { name: "Onions", category: "Produce", aisle: "", qty: "1" },
        { name: "Sour Cream", category: "Chilled - Dairy", aisle: "", qty: "8 Oz" },
        { name: "Medium Tortillas", category: "Boxes/aisles", aisle: "", qty: "1" }
    ]
  },
  { 
    title: "Breakfast for Dinner", 
    method: "Grill/Griddle", 
    ingredients: [
        { name: "Bacon", category: "Chilled - Meat", aisle: "", qty: "1 lbs" },
        { name: "Eggs", category: "Chilled - Dairy", aisle: "", qty: "12" },
        { name: "Hashbrowns", category: "Frozen", aisle: "", qty: "1 Bag" },
        { name: "Pancake Mix", category: "Boxes/aisles", aisle: "5", qty: "4 cups" },
        { name: "Pumpkin Bread/Pancake mix", category: "Boxes/aisles", aisle: "", qty: "4 cups" },
        { name: "Sliced American Cheese", category: "Chilled - Dairy", aisle: "", qty: "12 Slices" },
        { name: "Syrup", category: "Boxes/aisles", aisle: "", qty: "1" },
        { name: "Fruit - Canned", category: "Boxes/aisles", aisle: "", qty: "2" },
        { name: "Bread - Sandwich", category: "Boxes/aisles", aisle: "", qty: "1" }
    ]
  },
  { 
    title: "Chicken Fajitas", 
    method: "Black stone", 
    ingredients: [
        { name: "Mexican/Spanish Rice", category: "Boxes/aisles", aisle: "", qty: "1 Box" },
        { name: "Chicken Breasts", category: "Chilled - Meat", aisle: "", qty: "6" },
        { name: "Shredded Colby Jack", category: "Chilled - Dairy", aisle: "", qty: "16 oz" },
        { name: "Green Pepper", category: "Produce", aisle: "", qty: "2" },
        { name: "Red Pepper", category: "Produce", aisle: "", qty: "1" },
        { name: "Onions", category: "Produce", aisle: "", qty: "3" },
        { name: "Medium Tortillas", category: "Breads", aisle: "", qty: "1 Bag" },
        { name: "Cumin", category: "Spices", aisle: "", qty: "1 Table Spoon" },
        { name: "Lime Juice", category: "Produce", aisle: "", qty: "1 Oz" }
    ] 
  },
  { 
    title: "Chili Cheese Dogs/Hot Dogs/Brats", 
    method: "Grill/Griddle", 
    ingredients: [
        { name: "Chili", category: "Boxes/aisles", aisle: "", qty: "1 Can" },
        { name: "Bags of Chips", category: "Boxes/aisles", aisle: "", qty: "2" },
        { name: "Corn", category: "Frozen", aisle: "", qty: "1 Bag" },
        { name: "Hot dogs", category: "Chilled - Meat", aisle: "", qty: "1 Packs" },
        { name: '"a Side" (e.g., Potato Salad / Coleslaw)', category: "Chilled - Dairy", aisle: "", qty: "1" },
        { name: "Hot Dog Buns", category: "Breads", aisle: "", qty: "1 Pack" },
        { name: "Brats", category: "Chilled - Meat", aisle: "", qty: "1 Pack" }
    ] 
  },
  { 
    title: "Baked Teriyaki Chicken w/ Rice", 
    method: "Oven", 
    ingredients: [
        { name: "Rice Bag", category: "Boxes/aisles", aisle: "", qty: "2 cups" },
        { name: "Teriyaki Chicken", category: "Frozen", aisle: "", qty: "1 Bag" },
        { name: "Colby Jack Shredded", category: "Chilled - Dairy", aisle: "", qty: "8 oz" },
        { name: "Bagged Vegetables", category: "Frozen", aisle: "", qty: "1" }
    ] 
  },
  { 
    title: "Chicken Quesadillas", 
    method: "Griddle", 
    ingredients: [
        { name: "Shredded Colby Jack", category: "Chilled - Dairy", aisle: "", qty: "8 oz" },
        { name: "Sliced Colby Jack", category: "Chilled - Dairy", aisle: "", qty: "1 Pack" },
        { name: "Queso Dip", category: "Chilled - Dairy", aisle: "", qty: "16 Oz" },
        { name: "Medium Tortillas", category: "Breads", aisle: "", qty: "1 Bag" },
        { name: "Chicken - Canned", category: "Boxes/aisles", aisle: "", qty: "3 cans" }
    ] 
  },
  { 
    title: "Chicken Alfredo", 
    method: "Oven", 
    ingredients: [
        { name: "Corn", category: "Boxes/aisles", aisle: "", qty: "1 Can" },
        { name: "Texas Toast", category: "Frozen", aisle: "", qty: "2 Boxes" },
        { name: "Chicken Breasts", category: "Chilled - Meat", aisle: "", qty: "4 Large" },
        { name: "Pasta - Fettucine", category: "Boxes/aisles", aisle: "", qty: "1 Box" },
        { name: "Alfredo Sauce", category: "Boxes/aisles", aisle: "", qty: "1 Jar" }
    ] 
  },
  { 
    title: "Spaghetti + Meatballs", 
    method: "Stove", 
    ingredients: [
        { name: "Spaghetti Sauce", category: "Boxes/aisles", aisle: "", qty: "1 Jar" },
        { name: "Texas Toast", category: "Frozen", aisle: "", qty: "2 Boxes" },
        { name: "Meatballs", category: "Frozen", aisle: "", qty: "1 Bag" },
        { name: "Corn", category: "Frozen", aisle: "", qty: "1 Bag" },
        { name: '"a Side" (e.g., Potato Salad / Coleslaw)', category: "Chilled - Dairy", aisle: "", qty: "1" },
        { name: "Green Beans", category: "Produce - Refrigerated", aisle: "", qty: "1 Bag" }
    ] 
  },
  { 
    title: "Mississippi Roast", 
    method: "Slow Cooker", 
    ingredients: [
        { name: "Chuck Roast", category: "Chilled - Meat", aisle: "", qty: ">3 lbs" },
        { name: "Ranch Dressing Powder", category: "Boxes/aisles", aisle: "", qty: "1 Packet" },
        { name: "Au Jus Powder", category: "Boxes/aisles", aisle: "", qty: "1 Packet" },
        { name: "Butter", category: "Chilled - Dairy", aisle: "", qty: "1/2 Stick" },
        { name: "Pepperoncini Peppers", category: "Boxes/aisles", aisle: "", qty: "1 Jar" },
        { name: "Potatoes - Baked/Mashed", category: "Produce", aisle: "", qty: "5 Lbs" }
    ] 
  },
  { 
    title: "Meatloaf", 
    method: "Oven", 
    ingredients: [
        { name: "Ground Beef", category: "Chilled - Meat", aisle: "", qty: "3 lbs" },
        { name: "Garlic Minced", category: "Boxes/aisles", aisle: "", qty: "1 oz" },
        { name: "Salad", category: "Produce - Refrigerated", aisle: "", qty: "1 Bag" },
        { name: "Potatoes - Baked/Mashed", category: "Produce", aisle: "", qty: "3 Lbs" },
        { name: "Bagged Vegetables", category: "Frozen", aisle: "", qty: "2 Bags" },
        { name: "Ketchup", category: "Boxes/aisles", aisle: "", qty: "1 Cup" },
        { name: "Brown Sugar", category: "Boxes/aisles", aisle: "", qty: "1 Cup" },
        { name: "Bread Crumbs", category: "Boxes/aisles", aisle: "", qty: "1 Cup" },
        { name: "Eggs", category: "Chilled - Dairy", aisle: "", qty: "1" }
    ] 
  },
  { 
    title: "Grilled Cheese and Tomato Soup", 
    method: "Oven", 
    ingredients: [
        { name: "Bread - Sandwich", category: "Breads", aisle: "", qty: "1 loaf" },
        { name: "Sliced American Cheese", category: "Chilled - Dairy", aisle: "", qty: "1 pack" },
        { name: "Sliced Colby Jack", category: "Chilled - Dairy", aisle: "", qty: "1 pack" },
        { name: "Sliced Gouda", category: "Chilled - Dairy", aisle: "", qty: "1 pack" },
        { name: "Tomato Soup", category: "Boxes/aisles", aisle: "", qty: "2 cans" },
        { name: "Bagged Vegetables", category: "Frozen", aisle: "", qty: "1" }
    ] 
  },
  { title: "LEFTOVERS", method: "", ingredients: [] },
  { title: "Order Pizza", method: "Takeout", ingredients: [] }
];

let meals = JSON.parse(localStorage.getItem("meals") || "null") || defaultMeals;
let weeklyPlan = JSON.parse(localStorage.getItem("weeklyPlan") || "{}");
let oneOffItems = JSON.parse(localStorage.getItem("oneOffItems") || "[]");
let allOneOffItemsMaster = JSON.parse(localStorage.getItem("allOneOffItemsMaster") || "[]");

// Data Migration & Initialization ---
// Converts old string-based weeklyPlan to new object-based one
Object.keys(weeklyPlan).forEach(day => {
    if (weeklyPlan[day] && typeof weeklyPlan[day] === 'string') {
        const mealTitle = weeklyPlan[day];
        const meal = meals.find(m => m.title === mealTitle);
        weeklyPlan[day] = {
            title: mealTitle,
            ingredients: meal ? meal.ingredients.reduce((acc, ing) => {
                acc[ing.name] = { have: false, notes: "", qty: ing.qty || "" };
                return acc;
            }, {}) : {}
        };
    }
});

// Ensure all meal ingredients have qty field
meals.forEach(meal => {
    meal.ingredients.forEach(ing => {
        if (!ing.hasOwnProperty('qty')) {
            ing.qty = "";
        }
    });
});

// Ensure all one-off items have qty field
oneOffItems.forEach(item => {
    if (!item.hasOwnProperty('qty')) {
        item.qty = "";
    }
});

// Migration: Populate master list from existing oneOffItems if master list is empty
if (allOneOffItemsMaster.length === 0 && oneOffItems.length > 0) {
    allOneOffItemsMaster = oneOffItems.map(item => ({
        name: item.name,
        category: item.category,
        aisle: item.aisle,
        qty: item.qty || ""
    }));
    localStorage.setItem("allOneOffItemsMaster", JSON.stringify(allOneOffItemsMaster));
}


// --- DATA PERSISTENCE ---

function saveData() {
  localStorage.setItem("meals", JSON.stringify(meals));
  localStorage.setItem("weeklyPlan", JSON.stringify(weeklyPlan));
  localStorage.setItem("oneOffItems", JSON.stringify(oneOffItems));
  localStorage.setItem("allOneOffItemsMaster", JSON.stringify(allOneOffItemsMaster));
  localStorage.setItem("categories", JSON.stringify(CATEGORIES));
}

// --- DOM ELEMENTS ---

const addMealBtn = document.getElementById("save-meal-btn");
const mealTitleEl = document.getElementById("meal-title");
const mealMethodEl = document.getElementById("meal-method");
const ingredientRowsEl = document.getElementById("ingredient-rows");
const addIngredientRowBtn = document.getElementById("add-ingredient-row-btn");
const editMealIndexEl = document.getElementById("edit-meal-index");
const mealListEl = document.getElementById("meal-list");
const weekSlotsEl = document.getElementById("week-slots");
const cancelEditBtn = document.getElementById("cancel-edit-btn");
const quickAddIngredientInputEl = document.getElementById("quick-add-ingredient-input");
const quickAddDropdownContentEl = document.getElementById("quick-add-dropdown-content");
const quickAddNotesEl = document.getElementById("quick-add-notes");
const quickAddQtyEl = document.getElementById("quick-add-qty");
const quickAddHaveEl = document.getElementById("quick-add-have");
const customItemNameEl = document.getElementById("custom-item-name");
const customItemCategoryEl = document.getElementById("custom-item-category");
const customItemAisleEl = document.getElementById("custom-item-aisle");
const customItemQtyEl = document.getElementById("custom-item-qty");
const customItemNotesEl = document.getElementById("custom-item-notes");
const customItemHaveEl = document.getElementById("custom-item-have");
const oneOffItemsListEl = document.getElementById("oneoff-items-list");
const newCategoryInputEl = document.getElementById("new-category-input");
const categoriesListEl = document.getElementById("categories-list");
const mealSearchEl = document.getElementById("meal-search");
const mealSortEl = document.getElementById("meal-sort");
const itemsListEl = document.getElementById("items-list");
const itemsSearchEl = document.getElementById("items-search");
const itemsSortEl = document.getElementById("items-sort");

// Store all ingredients for Quick Add
let allIngredients = [];
let allIngredientNames = []; // For ingredient name autocomplete in dictionary

// --- DICTIONARY TAB ---

function updateAllIngredientNames() {
  const uniqueNames = new Set();
  meals.forEach(meal => {
    meal.ingredients.forEach(ing => {
      uniqueNames.add(ing.name);
    });
  });
  allIngredientNames = Array.from(uniqueNames).sort((a, b) => a.localeCompare(b, undefined, {sensitivity: 'base'}));
}

function createIngredientRow(ingredient = {}) {
    const div = document.createElement("div");
    div.className = "ingredient-row";
    
    const name = ingredient.name || "";
    const category = ingredient.category || CATEGORIES[0];
    const aisle = ingredient.aisle || "";
    const qty = ingredient.qty || "";
    
    // 1. Name Input with Dropdown
    const nameDropdownDiv = document.createElement("div");
    nameDropdownDiv.className = "ingredient-name-dropdown";
    
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Ingredient Name";
    nameInput.value = name;
    
    const nameDropdownContent = document.createElement("div");
    nameDropdownContent.className = "ingredient-name-dropdown-content";
    
    const renderNameDropdown = (names) => {
      nameDropdownContent.innerHTML = '';
      if (names.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'No matches - will create new';
        nameDropdownContent.appendChild(noResults);
        return;
      }
      names.forEach(n => {
        const nameDiv = document.createElement('div');
        nameDiv.textContent = n;
        nameDiv.onclick = () => {
          nameInput.value = n;
          nameDropdownContent.style.display = 'none';
        };
        nameDropdownContent.appendChild(nameDiv);
      });
    };
    
    nameInput.addEventListener('focus', () => {
      updateAllIngredientNames();
      renderNameDropdown(allIngredientNames);
      nameDropdownContent.style.display = 'block';
    });
    
    nameInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allIngredientNames.filter(n => n.toLowerCase().includes(searchTerm));
      renderNameDropdown(filtered);
      nameDropdownContent.style.display = 'block';
    });
    
    nameDropdownDiv.appendChild(nameInput);
    nameDropdownDiv.appendChild(nameDropdownContent);
    
    // 2. Category Select
    const categorySelect = document.createElement("select");
    categorySelect.innerHTML = CATEGORIES.map(c => `<option value="${c}" ${c === category ? 'selected' : ''}>${c}</option>`).join("");
    
    // 3. Quantity Input
    const qtyInput = document.createElement("input");
    qtyInput.type = "text";
    qtyInput.placeholder = "Qty";
    qtyInput.value = qty;
    
    // 4. Aisle Input
    const aisleInput = document.createElement("input");
    aisleInput.type = "text";
    aisleInput.placeholder = "Aisle #";
    aisleInput.value = aisle;
    
    // 5. Delete Button
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete";
    deleteBtn.textContent = "X";
    deleteBtn.onclick = () => div.remove();
    
    div.appendChild(nameDropdownDiv);
    div.appendChild(categorySelect);
    div.appendChild(qtyInput);
    div.appendChild(aisleInput);
    div.appendChild(deleteBtn);
    
    ingredientRowsEl.appendChild(div);
}

// Close ingredient name dropdowns when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.ingredient-name-dropdown') && !e.target.closest('.filterable-dropdown')) {
    document.querySelectorAll('.ingredient-name-dropdown-content').forEach(dropdown => {
      dropdown.style.display = 'none';
    });
    quickAddDropdownContentEl.style.display = 'none';
  }
});

addIngredientRowBtn.onclick = () => createIngredientRow();

cancelEditBtn.onclick = () => clearMealForm();

function clearMealForm() {
    mealTitleEl.value = "";
    mealMethodEl.value = "";
    ingredientRowsEl.innerHTML = "";
    editMealIndexEl.value = "";
    addMealBtn.textContent = "Save Meal";
    cancelEditBtn.style.display = "none";
}

function loadMealForEdit(index) {
    const meal = meals[index];
    mealTitleEl.value = meal.title;
    mealMethodEl.value = meal.method;
    ingredientRowsEl.innerHTML = "";
    meal.ingredients.forEach(createIngredientRow);
    editMealIndexEl.value = index;
    addMealBtn.textContent = "Update Meal";
    cancelEditBtn.style.display = "inline-block";
    window.scrollTo(0, 0); // Scroll to top to see form
}

addMealBtn.onclick = () => {
    const title = mealTitleEl.value.trim();
    const method = mealMethodEl.value.trim();
    if (!title) return alert("Title is required");

    const ingredients = [];
    document.querySelectorAll("#ingredient-rows .ingredient-row").forEach(row => {
        const name = row.children[0].querySelector('input').value.trim();
        const category = row.children[1].value;
        const qty = row.children[2].value.trim();
        const aisle = row.children[3].value.trim();
        if (name) {
            ingredients.push({ name, category, qty, aisle });
        }
    });
    
    const meal = { title, method, ingredients };
    const editIndex = editMealIndexEl.value;
    
    if (editIndex !== "") {
        const oldMeal = meals[editIndex];
        meals[editIndex] = meal; // Update existing
        
        // Sync weeklyPlan: Update ingredient references if meal was edited
        syncWeeklyPlanAfterMealEdit(oldMeal, meal);
    } else {
        meals.push(meal); // Add new
    }
    
    saveData();
    updateAllIngredientNames();
    renderMeals();
    renderPlanner(); // Update planner dropdowns
    renderItems();
    clearMealForm();
};

// Sync weeklyPlan when a meal's ingredients are renamed/changed
function syncWeeklyPlanAfterMealEdit(oldMeal, newMeal) {
    // Find all days using this meal
    Object.keys(weeklyPlan).forEach(day => {
        if (weeklyPlan[day].title === newMeal.title) {
            // Create map of old ingredient names to new names
            const oldNames = oldMeal.ingredients.map(ing => ing.name);
            const newNames = newMeal.ingredients.map(ing => ing.name);
            
            // Create new ingredients object with updated names
            const updatedIngredients = {};
            
            newMeal.ingredients.forEach((newIng, index) => {
                const oldIngName = oldNames[index];
                const newIngName = newIng.name;
                
                // If ingredient was renamed, transfer the state from old name to new name
                if (oldIngName && weeklyPlan[day].ingredients[oldIngName]) {
                    updatedIngredients[newIngName] = weeklyPlan[day].ingredients[oldIngName];
                    // Update qty from meal if it changed
                    if (newIng.qty) {
                        updatedIngredients[newIngName].qty = newIng.qty;
                    }
                } else if (weeklyPlan[day].ingredients[newIngName]) {
                    // Ingredient name unchanged, keep existing state
                    updatedIngredients[newIngName] = weeklyPlan[day].ingredients[newIngName];
                } else {
                    // New ingredient added to meal
                    updatedIngredients[newIngName] = {
                        have: false,
                        notes: "",
                        qty: newIng.qty || ""
                    };
                }
            });
            
            // Replace with cleaned ingredient list (removes stale names)
            weeklyPlan[day].ingredients = updatedIngredients;
        }
    });
}

function renderMeals() {
  const searchTerm = mealSearchEl.value.toLowerCase();
  const sortBy = mealSortEl.value;
  
  // Filter meals
  let filteredMeals = meals.map((m, i) => ({meal: m, index: i})).filter(item => {
    if (!searchTerm) return true;
    
    const m = item.meal;
    const matchesName = m.title.toLowerCase().includes(searchTerm);
    const matchesMethod = m.method.toLowerCase().includes(searchTerm);
    const matchesIngredient = m.ingredients.some(ing => ing.name.toLowerCase().includes(searchTerm));
    
    return matchesName || matchesMethod || matchesIngredient;
  });
  
  // Sort meals
  filteredMeals.sort((a, b) => {
    switch(sortBy) {
      case 'name':
        return a.meal.title.localeCompare(b.meal.title);
      case 'method':
        return a.meal.method.localeCompare(b.meal.method);
      case 'ingredients':
        return b.meal.ingredients.length - a.meal.ingredients.length;
      default:
        return 0;
    }
  });
  
  mealListEl.innerHTML = "";
  
  if (filteredMeals.length === 0) {
    mealListEl.innerHTML = '<div class="card"><p>No meals found matching your search.</p></div>';
    return;
  }
  
  filteredMeals.forEach(item => {
    const m = item.meal;
    const i = item.index;
    const div = document.createElement("div");
    div.className = "card";
    const ingredientsList = m.ingredients.map(ing => `${ing.name} (${ing.category})`).join(", ") || "No ingredients";
    const methodDisplay = m.method ? `[${m.method.replace(/[\[\]]/g, '')}]` : '';
    div.innerHTML = `<strong>${methodDisplay} ${m.title}</strong><br>
    <small>${ingredientsList}</small><br>
    <button class="blue" onclick="loadMealForEdit(${i})">Edit</button>
    <button class="delete" onclick="deleteMeal(${i})">Delete</button>`;
    mealListEl.appendChild(div);
  });
}

// Add event listeners for search and sort
mealSearchEl.addEventListener('input', renderMeals);
mealSortEl.addEventListener('change', renderMeals);

function deleteMeal(i) {
  if (!confirm(`Are you sure you want to delete "${meals[i].title}"?`)) return;
  meals.splice(i, 1);
  saveData();
  updateAllIngredientNames();
  renderMeals();
  renderPlanner();
  renderItems();
}

// --- PLANNER TAB ---

function populateQuickAddDropdown() {
  const uniqueIngredients = new Map();
  
  // Add ingredients from meals
  meals.forEach(meal => {
    meal.ingredients.forEach(ing => {
      if (!uniqueIngredients.has(ing.name)) {
        uniqueIngredients.set(ing.name, ing);
      }
    });
  });
  
  // Add one-off items to the dropdown (both current week and master list)
  oneOffItems.forEach(item => {
    if (!uniqueIngredients.has(item.name)) {
      uniqueIngredients.set(item.name, {
        name: item.name,
        category: item.category,
        aisle: item.aisle,
        qty: item.qty || ""
      });
    }
  });
  
  // Add all items from master list
  allOneOffItemsMaster.forEach(item => {
    if (!uniqueIngredients.has(item.name)) {
      uniqueIngredients.set(item.name, {
        name: item.name,
        category: item.category,
        aisle: item.aisle,
        qty: item.qty || ""
      });
    }
  });
  
  allIngredients = Array.from(uniqueIngredients.values()).sort((a, b) => a.name.localeCompare(b.name));
  renderQuickAddDropdown(allIngredients);
}

function renderQuickAddDropdown(ingredients) {
  quickAddDropdownContentEl.innerHTML = '';
  
  if (ingredients.length === 0) {
    const noResults = document.createElement('div');
    noResults.className = 'no-results';
    noResults.textContent = 'No ingredients found';
    quickAddDropdownContentEl.appendChild(noResults);
    return;
  }
  
  ingredients.forEach(ing => {
    const div = document.createElement('div');
    div.textContent = ing.name;
    div.setAttribute('data-name', ing.name);
    div.setAttribute('data-category', ing.category);
    div.setAttribute('data-aisle', ing.aisle);
    div.onmousedown = (e) => {
      // Use mousedown instead of click to fire before blur/focus events
      e.preventDefault(); // Prevent input from losing focus
      quickAddIngredientInputEl.value = ing.name;
      quickAddIngredientInputEl.setAttribute('data-selected-category', ing.category);
      quickAddIngredientInputEl.setAttribute('data-selected-aisle', ing.aisle);
      quickAddDropdownContentEl.style.display = 'none';
    };
    quickAddDropdownContentEl.appendChild(div);
  });
}

// Filterable dropdown event handlers
quickAddIngredientInputEl.addEventListener('focus', () => {
  quickAddDropdownContentEl.style.display = 'block';
  renderQuickAddDropdown(allIngredients);
});

quickAddIngredientInputEl.addEventListener('input', (e) => {
  const searchTerm = e.target.value.toLowerCase();
  const filtered = allIngredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));
  renderQuickAddDropdown(filtered);
  quickAddDropdownContentEl.style.display = 'block';
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.filterable-dropdown')) {
    quickAddDropdownContentEl.style.display = 'none';
  }
});

// Collapsible New Custom Item section
document.getElementById('custom-item-header').addEventListener('click', () => {
  const content = document.getElementById('custom-item-content');
  const arrow = document.querySelector('#custom-item-header .collapsible-arrow');
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    arrow.textContent = '‚ñº';
  } else {
    content.classList.add('show');
    arrow.textContent = '‚ñ≤';
  }
});

// Collapsible Quick Add Item section
document.getElementById('quick-add-header').addEventListener('click', () => {
  const content = document.getElementById('quick-add-content');
  const arrow = document.querySelector('#quick-add-header .collapsible-arrow');
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    arrow.textContent = '‚ñº';
  } else {
    content.classList.add('show');
    arrow.textContent = '‚ñ≤';
  }
});

function populateCustomCategoryDropdown() {
  customItemCategoryEl.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
}

function renderCategories() {
  categoriesListEl.innerHTML = '';
  CATEGORIES.forEach((category, index) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'draggable-item';
    catDiv.draggable = true;
    catDiv.dataset.index = index;
    
    // Drag handle
    const dragHandle = document.createElement('span');
    dragHandle.className = 'drag-handle';
    dragHandle.textContent = '‚ò∞';
    dragHandle.title = 'Drag to reorder';
    
    const catInput = document.createElement('input');
    catInput.type = 'text';
    catInput.value = category;
    catInput.style.flex = '1';
    catInput.onchange = (e) => {
      const newName = e.target.value.trim();
      if (newName && !CATEGORIES.includes(newName)) {
        CATEGORIES[index] = newName;
        saveData();
        populateCustomCategoryDropdown();
        // Update any existing ingredients/items with the old category name
        meals.forEach(meal => {
          meal.ingredients.forEach(ing => {
            if (ing.category === category) ing.category = newName;
          });
        });
        oneOffItems.forEach(item => {
          if (item.category === category) item.category = newName;
        });
        saveData();
      } else if (!newName) {
        alert('Category name cannot be empty');
        catInput.value = category;
      } else if (CATEGORIES.includes(newName) && newName !== category) {
        alert('Category already exists');
        catInput.value = category;
      }
    };
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete';
    deleteBtn.textContent = 'Delete';
    deleteBtn.style.margin = '0';
    deleteBtn.onclick = () => {
      if (confirm(`Delete category "${category}"? Items in this category will remain but you'll need to reassign them.`)) {
        CATEGORIES.splice(index, 1);
        saveData();
        renderCategories();
        populateCustomCategoryDropdown();
      }
    };
    
    // Mouse drag events
    catDiv.addEventListener('dragstart', (e) => {
      catDiv.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', index);
    });
    
    catDiv.addEventListener('dragend', () => {
      catDiv.classList.remove('dragging');
    });
    
    catDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      const draggingItem = document.querySelector('.dragging');
      if (draggingItem && draggingItem !== catDiv) {
        const rect = catDiv.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        if (e.clientY < midpoint) {
          catDiv.parentNode.insertBefore(draggingItem, catDiv);
        } else {
          catDiv.parentNode.insertBefore(draggingItem, catDiv.nextSibling);
        }
      }
    });
    
    catDiv.addEventListener('drop', (e) => {
      e.preventDefault();
      const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
      const items = Array.from(categoriesListEl.children);
      const newOrder = items.map(item => CATEGORIES[parseInt(item.dataset.index)]);
      CATEGORIES.length = 0;
      CATEGORIES.push(...newOrder);
      saveData();
      renderCategories();
      populateCustomCategoryDropdown();
    });
    
    // Touch events for mobile
    let touchStartY = 0;
    let touchElement = null;
    
    catDiv.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
      touchElement = catDiv;
      catDiv.classList.add('dragging');
      catDiv.style.opacity = '0.5';
    });
    
    catDiv.addEventListener('touchmove', (e) => {
      if (!touchElement) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const currentY = touch.clientY;
      
      // Find which element we're over
      const elements = Array.from(categoriesListEl.children);
      for (let i = 0; i < elements.length; i++) {
        const elem = elements[i];
        if (elem === touchElement) continue;
        
        const rect = elem.getBoundingClientRect();
        if (currentY >= rect.top && currentY <= rect.bottom) {
          const midpoint = rect.top + rect.height / 2;
          if (currentY < midpoint) {
            categoriesListEl.insertBefore(touchElement, elem);
          } else {
            categoriesListEl.insertBefore(touchElement, elem.nextSibling);
          }
          break;
        }
      }
    });
    
    catDiv.addEventListener('touchend', () => {
      if (!touchElement) return;
      
      catDiv.classList.remove('dragging');
      catDiv.style.opacity = '';
      touchElement = null;
      
      // Save new order
      const items = Array.from(categoriesListEl.children);
      const newOrder = items.map(item => CATEGORIES[parseInt(item.dataset.index)]);
      CATEGORIES.length = 0;
      CATEGORIES.push(...newOrder);
      saveData();
      renderCategories();
      populateCustomCategoryDropdown();
    });
    
    catDiv.appendChild(dragHandle);
    catDiv.appendChild(catInput);
    catDiv.appendChild(deleteBtn);
    categoriesListEl.appendChild(catDiv);
  });
}

document.getElementById('add-category-btn').onclick = () => {
  const newCategory = newCategoryInputEl.value.trim();
  if (!newCategory) {
    alert('Please enter a category name');
    return;
  }
  if (CATEGORIES.includes(newCategory)) {
    alert('Category already exists');
    return;
  }
  
  CATEGORIES.push(newCategory);
  saveData();
  renderCategories();
  populateCustomCategoryDropdown();
  newCategoryInputEl.value = '';
};

// --- MANAGE ITEMS ---

function getAllItems() {
  const itemsMap = new Map(); // item name -> {count, category, aisle, qty}
  
  // Collect from meals
  meals.forEach(meal => {
    meal.ingredients.forEach(ing => {
      const key = ing.name.toLowerCase();
      if (itemsMap.has(key)) {
        itemsMap.get(key).count++;
      } else {
        itemsMap.set(key, {
          name: ing.name,
          count: 1,
          category: ing.category,
          aisle: ing.aisle,
          qty: ing.qty
        });
      }
    });
  });
  
  // Include one-off items from current week (they show as used in 0 meals but are still managed items)
  oneOffItems.forEach(item => {
    const key = item.name.toLowerCase();
    if (itemsMap.has(key)) {
      // Item exists from meals, keep the meal count
      itemsMap.get(key).count += 0; // No additional count, already tracked
    } else {
      // One-off item not in any meal
      itemsMap.set(key, {
        name: item.name,
        count: 0, // Not used in any meal
        category: item.category,
        aisle: item.aisle,
        qty: item.qty || ""
      });
    }
  });
  
  // Include all items from master list (items that were previously used)
  allOneOffItemsMaster.forEach(item => {
    const key = item.name.toLowerCase();
    if (!itemsMap.has(key)) {
      // Item not currently in use, but exists in master list
      itemsMap.set(key, {
        name: item.name,
        count: 0, // Not currently used
        category: item.category,
        aisle: item.aisle,
        qty: item.qty || ""
      });
    }
  });
  
  return Array.from(itemsMap.values());
}

function renderItems() {
  const items = getAllItems();
  const searchTerm = itemsSearchEl.value.toLowerCase();
  const sortBy = itemsSortEl.value;
  
  // Filter items
  const filteredItems = items.filter(item => 
    item.name.toLowerCase().includes(searchTerm)
  );
  
  // Sort items
  filteredItems.sort((a, b) => {
    if (sortBy === 'name') {
      return a.name.localeCompare(b.name, undefined, {sensitivity: 'base'});
    } else if (sortBy === 'usage-high') {
      return b.count - a.count; // High to Low
    } else if (sortBy === 'usage-low') {
      return a.count - b.count; // Low to High
    }
    return 0;
  });
  
  itemsListEl.innerHTML = '';
  
  if (filteredItems.length === 0) {
    itemsListEl.innerHTML = '<p style="color: #999;">No items found.</p>';
    return;
  }
  
  filteredItems.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'item-box';
    itemDiv.style.display = 'flex';
    itemDiv.style.alignItems = 'center';
    itemDiv.style.gap = '0.5em';
    itemDiv.style.marginBottom = '0.5em';
    itemDiv.style.padding = '0.5em';
    
    const itemInfo = document.createElement('div');
    itemInfo.style.flex = '1';
    itemInfo.innerHTML = `<strong>${item.name}</strong><br>
      <small>Used in <strong>${item.count}</strong> meal${item.count > 1 ? 's' : ''} | Category: ${item.category || 'None'}</small>`;
    
    const renameBtn = document.createElement('button');
    renameBtn.className = 'blue';
    renameBtn.textContent = 'Rename';
    renameBtn.style.margin = '0';
    renameBtn.onclick = () => {
      const newName = prompt(`Rename "${item.name}" to:`, item.name);
      if (!newName || newName.trim() === '' || newName.trim() === item.name) return;
      
      const trimmedName = newName.trim();
      
      // Update in all meals
      let updateCount = 0;
      meals.forEach(meal => {
        meal.ingredients.forEach(ing => {
          if (ing.name.toLowerCase() === item.name.toLowerCase()) {
            ing.name = trimmedName;
            updateCount++;
          }
        });
      });
      
      // Update in weekly plan
      Object.keys(weeklyPlan).forEach(day => {
        if (weeklyPlan[day].ingredients[item.name]) {
          weeklyPlan[day].ingredients[trimmedName] = weeklyPlan[day].ingredients[item.name];
          delete weeklyPlan[day].ingredients[item.name];
        }
      });
      
      // Update one-off items
      oneOffItems.forEach(oneOff => {
        if (oneOff.name.toLowerCase() === item.name.toLowerCase()) {
          oneOff.name = trimmedName;
        }
      });
      
      saveData();
      updateAllIngredientNames();
      renderItems();
      renderMeals();
      renderPlanner();
      alert(`Renamed "${item.name}" to "${trimmedName}" in ${updateCount} location(s).`);
    };
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete';
    deleteBtn.textContent = 'Delete';
    deleteBtn.style.margin = '0';
    deleteBtn.onclick = () => {
      if (!confirm(`Delete "${item.name}" from all meals? This will remove it from ${item.count} meal(s).`)) return;
      
      // Remove from all meals
      meals.forEach(meal => {
        meal.ingredients = meal.ingredients.filter(ing => 
          ing.name.toLowerCase() !== item.name.toLowerCase()
        );
      });
      
      // Remove from weekly plan
      Object.keys(weeklyPlan).forEach(day => {
        if (weeklyPlan[day].ingredients[item.name]) {
          delete weeklyPlan[day].ingredients[item.name];
        }
      });
      
      // Remove from one-off items
      oneOffItems = oneOffItems.filter(oneOff => 
        oneOff.name.toLowerCase() !== item.name.toLowerCase()
      );
      
      saveData();
      updateAllIngredientNames();
      renderItems();
      renderMeals();
      renderPlanner();
      renderOneOffItems();
      alert(`Deleted "${item.name}" from all meals.`);
    };
    
    itemDiv.appendChild(itemInfo);
    itemDiv.appendChild(renameBtn);
    itemDiv.appendChild(deleteBtn);
    itemsListEl.appendChild(itemDiv);
  });
}

// Add event listeners for items search and sort
itemsSearchEl.addEventListener('input', renderItems);
itemsSortEl.addEventListener('change', renderItems);

function renderOneOffItems() {
  oneOffItemsListEl.innerHTML = '';
  if (oneOffItems.length === 0) {
    oneOffItemsListEl.innerHTML = '<small>No one-off items added yet.</small>';
    return;
  }
  
  oneOffItems.forEach((item, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'item-box';
    itemDiv.style.display = 'grid';
    itemDiv.style.gridTemplateColumns = '2fr 1fr 1fr 2fr auto auto';
    itemDiv.style.gap = '0.5em';
    itemDiv.style.alignItems = 'center';
    itemDiv.style.marginBottom = '0.5em';
    itemDiv.style.padding = '0.5em';
    
    const nameSpan = document.createElement('strong');
    nameSpan.textContent = item.name;
    
    const qtySpan = document.createElement('small');
    qtySpan.textContent = item.qty || '-';
    qtySpan.style.color = '#666';
    
    const aisleSpan = document.createElement('small');
    aisleSpan.textContent = item.aisle ? `Aisle ${item.aisle}` : '-';
    aisleSpan.style.color = '#666';
    
    const notesSpan = document.createElement('small');
    notesSpan.textContent = item.notes || 'No notes';
    notesSpan.style.color = '#666';
    
    const haveCheckbox = document.createElement('input');
    haveCheckbox.type = 'checkbox';
    haveCheckbox.checked = item.have;
    haveCheckbox.onchange = (e) => {
      oneOffItems[index].have = e.target.checked;
      saveData();
    };
    
    const haveLabel = document.createElement('label');
    haveLabel.style.display = 'flex';
    haveLabel.style.alignItems = 'center';
    haveLabel.style.gap = '0.3em';
    haveLabel.style.fontWeight = 'normal';
    haveLabel.appendChild(haveCheckbox);
    haveLabel.appendChild(document.createTextNode('Have'));
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete';
    deleteBtn.textContent = 'Delete';
    deleteBtn.style.margin = '0';
    deleteBtn.onclick = () => {
      // Remove from this week's list only (keep in master list for future use)
      oneOffItems.splice(index, 1);
      saveData();
      renderOneOffItems();
      // Note: NOT calling populateQuickAddDropdown() or renderItems() 
      // because item still exists in master list
    };
    
    itemDiv.appendChild(nameSpan);
    itemDiv.appendChild(qtySpan);
    itemDiv.appendChild(aisleSpan);
    itemDiv.appendChild(notesSpan);
    itemDiv.appendChild(haveLabel);
    itemDiv.appendChild(deleteBtn);
    oneOffItemsListEl.appendChild(itemDiv);
  });
}

document.getElementById('quick-add-btn').onclick = () => {
  const ingredientName = quickAddIngredientInputEl.value.trim();
  const selectedCategory = quickAddIngredientInputEl.getAttribute('data-selected-category');
  const selectedAisle = quickAddIngredientInputEl.getAttribute('data-selected-aisle');
  
  if (!ingredientName) {
    alert('Please select an ingredient');
    return;
  }
  
  if (!selectedCategory) {
    alert('Please select a valid ingredient from the dropdown');
    return;
  }
  
  const item = {
    name: ingredientName,
    category: selectedCategory,
    aisle: selectedAisle || '',
    qty: quickAddQtyEl.value.trim(),
    notes: quickAddNotesEl.value.trim(),
    have: quickAddHaveEl.checked
  };
  
  // Add to current week's one-off items
  oneOffItems.push(item);
  
  // Add to master list if not already there
  const masterItem = {
    name: ingredientName,
    category: selectedCategory,
    aisle: selectedAisle || '',
    qty: quickAddQtyEl.value.trim()
  };
  const existsInMaster = allOneOffItemsMaster.some(i => i.name.toLowerCase() === ingredientName.toLowerCase());
  if (!existsInMaster) {
    allOneOffItemsMaster.push(masterItem);
  }
  
  saveData();
  populateQuickAddDropdown(); // Refresh dropdown with new item
  renderOneOffItems();
  renderItems(); // Update Manage Items list
  
  quickAddIngredientInputEl.value = '';
  quickAddIngredientInputEl.removeAttribute('data-selected-category');
  quickAddIngredientInputEl.removeAttribute('data-selected-aisle');
  quickAddQtyEl.value = '';
  quickAddNotesEl.value = '';
  quickAddHaveEl.checked = false;
};

document.getElementById('custom-item-btn').onclick = () => {
  const name = customItemNameEl.value.trim();
  if (!name) {
    alert('Please enter an item name');
    return;
  }
  
  const item = {
    name: name,
    category: customItemCategoryEl.value,
    aisle: customItemAisleEl.value.trim(),
    qty: customItemQtyEl.value.trim(),
    notes: customItemNotesEl.value.trim(),
    have: customItemHaveEl.checked
  };
  
  // Add to current week's one-off items
  oneOffItems.push(item);
  
  // Add to master list if not already there
  const masterItem = {
    name: name,
    category: customItemCategoryEl.value,
    aisle: customItemAisleEl.value.trim(),
    qty: customItemQtyEl.value.trim()
  };
  const existsInMaster = allOneOffItemsMaster.some(i => i.name.toLowerCase() === name.toLowerCase());
  if (!existsInMaster) {
    allOneOffItemsMaster.push(masterItem);
  }
  
  saveData();
  populateQuickAddDropdown(); // Refresh dropdown with new item
  renderOneOffItems();
  renderItems(); // Update Manage Items list
  
  customItemNameEl.value = '';
  customItemAisleEl.value = '';
  customItemQtyEl.value = '';
  customItemNotesEl.value = '';
  customItemHaveEl.checked = false;
};

function renderPlanner() {
  weekSlotsEl.innerHTML = "";
  
  // Get all days that have meals assigned
  const assignedDays = Object.keys(weeklyPlan).filter(key => weeklyPlan[key].title).sort();
  
  // Render assigned meals
  assignedDays.forEach(l => {
    const dayData = weeklyPlan[l];
    renderMealSlot(l, dayData);
  });
  
  // Render "Add Meal" row for next day
  renderAddMealRow();
}

function renderMealSlot(dayLetter, dayData) {
  const dayContainer = document.createElement('div');
  dayContainer.className = 'card';
  dayContainer.style.marginBottom = '1em';

  const dayHeader = document.createElement('div');
  dayHeader.style.display = 'flex';
  dayHeader.style.alignItems = 'center';
  dayHeader.style.gap = '0.5em';

  const label = document.createElement("span");
  label.textContent = `${dayLetter}. ${dayData.title}`;
  label.style.fontWeight = 'bold';
  label.style.fontSize = '1.1em';
  label.style.flex = '1';
  
  // Remove button (red -)
  const removeBtn = document.createElement('button');
  removeBtn.textContent = '‚àí';
  removeBtn.className = 'delete';
  removeBtn.style.padding = '0.4em 0.7em';
  removeBtn.style.fontSize = '1.2em';
  removeBtn.style.minWidth = '2.5em';
  removeBtn.style.lineHeight = '1';
  removeBtn.style.margin = '0';
  removeBtn.style.verticalAlign = 'middle';
  removeBtn.onclick = () => {
    delete weeklyPlan[dayLetter];
    saveData();
    renderPlanner();
  };
  
  // Expand/collapse ingredients button
  const ingredientsContainer = document.createElement('div');
  ingredientsContainer.style.display = 'none';
  ingredientsContainer.style.marginTop = '1em';
  ingredientsContainer.style.paddingLeft = '1em';
  ingredientsContainer.style.borderLeft = '3px solid #eee';

  const toggleBtn = document.createElement('button');
  toggleBtn.textContent = '‚ñº';
  toggleBtn.className = 'secondary';
  toggleBtn.style.padding = '0.4em 0.7em';
  toggleBtn.style.fontSize = '1.2em';
  toggleBtn.style.minWidth = '2.5em';
  toggleBtn.style.lineHeight = '1';
  toggleBtn.style.margin = '0';
  toggleBtn.style.verticalAlign = 'middle';
  toggleBtn.style.background = '#ff9800'; // Orange for expand
  toggleBtn.onclick = () => {
    const isHidden = ingredientsContainer.style.display === 'none';
    ingredientsContainer.style.display = isHidden ? 'block' : 'none';
    toggleBtn.textContent = isHidden ? '‚ñ≤' : '‚ñº';
    toggleBtn.style.background = isHidden ? '#9c27b0' : '#ff9800';
  };

  dayHeader.appendChild(label);
  dayHeader.appendChild(removeBtn);
  dayHeader.appendChild(toggleBtn);
  
  dayContainer.appendChild(dayHeader);
  dayContainer.appendChild(ingredientsContainer);

  // Render ingredients
  const selectedMeal = meals.find(m => m.title === dayData.title);
  if (selectedMeal && selectedMeal.ingredients.length > 0) {
    selectedMeal.ingredients.forEach(ing => {
      const ingState = dayData.ingredients[ing.name] || { have: false, notes: "", qty: ing.qty || "" };

      const ingRow = document.createElement('div');
      ingRow.style.display = 'grid';
      ingRow.style.gridTemplateColumns = '2fr 1fr 2fr auto';
      ingRow.style.gap = '0.5em';
      ingRow.style.alignItems = 'center';
      ingRow.style.marginBottom = '0.5em';

      const ingLabel = document.createElement('label');
      ingLabel.textContent = ing.name;
      ingLabel.style.fontWeight = 'normal';
      
      const qtyInput = document.createElement('input');
      qtyInput.type = 'text';
      qtyInput.placeholder = 'Qty...';
      qtyInput.value = ingState.qty;
      qtyInput.oninput = (e) => {
        weeklyPlan[dayLetter].ingredients[ing.name].qty = e.target.value;
        saveData();
      };
      
      const notesInput = document.createElement('input');
      notesInput.type = 'text';
      notesInput.placeholder = 'Notes...';
      notesInput.value = ingState.notes;
      notesInput.oninput = (e) => {
        weeklyPlan[dayLetter].ingredients[ing.name].notes = e.target.value;
        saveData();
      };

      const haveCheckbox = document.createElement('input');
      haveCheckbox.type = 'checkbox';
      haveCheckbox.checked = ingState.have;
      haveCheckbox.onchange = (e) => {
        weeklyPlan[dayLetter].ingredients[ing.name].have = e.target.checked;
        saveData();
      };
      
      const haveLabel = document.createElement('label');
      haveLabel.style.display = 'flex';
      haveLabel.style.alignItems = 'center';
      haveLabel.style.gap = '0.5em';
      haveLabel.style.fontWeight = 'normal';
      haveLabel.appendChild(haveCheckbox);
      haveLabel.appendChild(document.createTextNode('Have'));

      ingRow.appendChild(ingLabel);
      ingRow.appendChild(qtyInput);
      ingRow.appendChild(notesInput);
      ingRow.appendChild(haveLabel);
      ingredientsContainer.appendChild(ingRow);
    });
  } else {
    ingredientsContainer.innerHTML = '<small>No ingredients for this meal.</small>';
  }
  
  weekSlotsEl.appendChild(dayContainer);
}

function renderAddMealRow() {
  // Find next available day letter
  const usedLetters = Object.keys(weeklyPlan).filter(key => weeklyPlan[key].title);
  const nextLetter = DAY_LETTERS.find(l => !usedLetters.includes(l));
  
  if (!nextLetter) {
    // All days used
    return;
  }
  
  const addContainer = document.createElement('div');
  addContainer.className = 'card';
  addContainer.style.marginBottom = '1em';
  addContainer.style.background = '#f9f9f9';

  const addHeader = document.createElement('div');
  addHeader.style.display = 'flex';
  addHeader.style.alignItems = 'center';
  addHeader.style.gap = '0.5em';

  const label = document.createElement("span");
  label.textContent = `${nextLetter}. `;
  label.style.fontWeight = 'bold';
  label.style.fontSize = '1.2em';
  
  // Create searchable dropdown for meal selection
  const mealDropdownDiv = document.createElement("div");
  mealDropdownDiv.className = "filterable-dropdown";
  mealDropdownDiv.style.flex = "1";
  
  const mealInput = document.createElement("input");
  mealInput.type = "text";
  mealInput.placeholder = "Type to search meals...";
  
  const mealDropdownContent = document.createElement("div");
  mealDropdownContent.className = "filterable-dropdown-content";
  
  let selectedMeal = null;
  
  const renderMealDropdown = (filteredMeals) => {
    mealDropdownContent.innerHTML = '';
    
    if (filteredMeals.length === 0) {
      const noResults = document.createElement('div');
      noResults.className = 'no-results';
      noResults.textContent = 'No meals found';
      mealDropdownContent.appendChild(noResults);
      return;
    }
    
    filteredMeals.forEach(meal => {
      const div = document.createElement('div');
      const methodDisplay = meal.method ? `[${meal.method}] ` : '';
      div.textContent = `${methodDisplay}${meal.title}`;
      div.onmousedown = (e) => {
        e.preventDefault();
        selectedMeal = meal;
        mealInput.value = meal.title;
        mealDropdownContent.style.display = 'none';
      };
      mealDropdownContent.appendChild(div);
    });
  };
  
  mealInput.addEventListener('focus', () => {
    renderMealDropdown(meals);
    mealDropdownContent.style.display = 'block';
  });
  
  mealInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = meals.filter(m => 
      m.title.toLowerCase().includes(searchTerm) || 
      (m.method && m.method.toLowerCase().includes(searchTerm))
    );
    renderMealDropdown(filtered);
    mealDropdownContent.style.display = 'block';
  });
  
  mealDropdownDiv.appendChild(mealInput);
  mealDropdownDiv.appendChild(mealDropdownContent);
  
  // Add button (blue +)
  const addBtn = document.createElement('button');
  addBtn.textContent = '+';
  addBtn.className = 'blue';
  addBtn.style.padding = '0.4em 0.7em';
  addBtn.style.fontSize = '1.2em';
  addBtn.style.minWidth = '2.5em';
  addBtn.style.lineHeight = '1';
  addBtn.style.margin = '0';
  addBtn.style.verticalAlign = 'middle';
  addBtn.onclick = () => {
    if (!selectedMeal) {
      alert('Please select a meal first');
      return;
    }
    
    // Add meal to weekly plan
    weeklyPlan[nextLetter] = {
      title: selectedMeal.title,
      ingredients: selectedMeal.ingredients.reduce((acc, ing) => {
        acc[ing.name] = { have: false, notes: "", qty: ing.qty || "" };
        return acc;
      }, {})
    };
    saveData();
    renderPlanner();
  };

  addHeader.appendChild(label);
  addHeader.appendChild(mealDropdownDiv);
  addHeader.appendChild(addBtn);
  
  addContainer.appendChild(addHeader);
  weekSlotsEl.appendChild(addContainer);
}

document.getElementById("start-new-week-btn").onclick = () => {
    if (confirm("Start a new week? This will clear all current meal selections and one-off items. Your Dinner Dictionary and item history will be preserved.")) {
        // Clear weekly plan
        weeklyPlan = {};
        
        // Clear one-off items for this week (but keep master list)
        oneOffItems = [];
        
        saveData();
        renderPlanner();
        renderOneOffItems();
        
        alert("New week started! Your meal plan and one-off items have been cleared.");
    }
};

document.getElementById("generate-markdown-btn").onclick = () => {
  // Get all assigned days in order
  const letters = Object.keys(weeklyPlan).filter(key => weeklyPlan[key].title).sort();
  let md = "# __Potential meals__\n";
  md += "_Generated from: [SOUS List App](https://actuallyfro.github.io/SOUS-List/)_\n\n";
  const shoppingList = {}; // { Produce: { "Apples": { meals: ['A'], aisle: 'p' } } }
  
  // 1. Build Meal List & Aggregated Shopping List
  letters.forEach(l => {
    const dayPlan = weeklyPlan[l];
    if (dayPlan && dayPlan.title) {
        const meal = meals.find(m => m.title === dayPlan.title);
        if (meal) {
            const methodDisplay = meal.method ? `[${meal.method.replace(/[\[\]]/g, '')}] ` : "";
            md += `${l}. ${methodDisplay}${meal.title}\n`;
            
            meal.ingredients.forEach(ing => {
                if (!shoppingList[ing.category]) {
                    shoppingList[ing.category] = {};
                }
                
                const ingState = dayPlan.ingredients[ing.name] || { have: false, notes: "", qty: ing.qty || "" };
                
                if (!shoppingList[ing.category][ing.name]) {
                    // First occurrence - initialize with current state
                    shoppingList[ing.category][ing.name] = { 
                        meals: [], 
                        aisle: ing.aisle,
                        have: ingState.have,
                        notes: ingState.notes || "",
                        qty: ingState.qty || ""
                    };
                } else {
                    // Ingredient already exists - aggregate quantities and notes
                    
                    // Add quantity if present
                    if (ingState.qty) {
                        if (shoppingList[ing.category][ing.name].qty) {
                            shoppingList[ing.category][ing.name].qty += ` + ${ingState.qty}`;
                        } else {
                            shoppingList[ing.category][ing.name].qty = ingState.qty;
                        }
                    }
                    
                    // Aggregate notes
                    if (ingState.notes && !shoppingList[ing.category][ing.name].notes.includes(ingState.notes)) {
                        shoppingList[ing.category][ing.name].notes = shoppingList[ing.category][ing.name].notes 
                          ? `${shoppingList[ing.category][ing.name].notes}; ${ingState.notes}` 
                          : ingState.notes;
                    }
                    
                    // If marked as "have" in any meal, we have it (can use for all meals)
                    if (ingState.have) {
                        shoppingList[ing.category][ing.name].have = true;
                    }
                }
                shoppingList[ing.category][ing.name].meals.push(l);
            });
        }
    }
  });
  
  // 2. Add One-Off Items to Shopping List
  oneOffItems.forEach(item => {
    if (!shoppingList[item.category]) {
      shoppingList[item.category] = {};
    }
    if (!shoppingList[item.category][item.name]) {
      shoppingList[item.category][item.name] = {
        meals: [],
        aisle: item.aisle,
        have: item.have,
        notes: item.notes,
        qty: item.qty || ""
      };
    } else {
      // If item already exists from meals, merge the data
      if (item.qty) {
        if (shoppingList[item.category][item.name].qty) {
          shoppingList[item.category][item.name].qty += ` + ${item.qty}`;
        } else {
          shoppingList[item.category][item.name].qty = item.qty;
        }
      }
      
      if (item.notes && !shoppingList[item.category][item.name].notes.includes(item.notes)) {
        shoppingList[item.category][item.name].notes = shoppingList[item.category][item.name].notes 
          ? `${shoppingList[item.category][item.name].notes}; ${item.notes}` 
          : item.notes;
      }
      // If marked as "have" in one-off, we have it
      if (item.have) {
        shoppingList[item.category][item.name].have = true;
      }
    }
  });
  
  md += "\n# __Grocery List__ [Related Meal Label/Tag]\n";
  
  // 3. Build Markdown Shopping List from Aggregated Data
  // Check if "Have" items should be included
  const includeHaveItems = document.getElementById("include-have-items-toggle").checked;
  
  CATEGORIES.forEach(category => {
    if (shoppingList[category]) {
        const categoryItems = Object.keys(shoppingList[category]).sort().filter(itemName => {
          const item = shoppingList[category][itemName];
          // If includeHaveItems is OFF and item is marked as "have", skip it
          if (!includeHaveItems && item.have) {
            return false;
          }
          return true;
        });
        
        // Only add category header if there are items to display
        if (categoryItems.length > 0) {
          md += `## ${category}\n`;
          categoryItems.forEach(itemName => {
              const item = shoppingList[category][itemName];
              const mealTags = item.meals.length > 0 ? ' ' + item.meals.map(m => `[${m}]`).join('') : '';
              const aisleText = item.aisle ? ` (Aisle ${item.aisle})` : '';
              const qtyText = item.qty ? ` {${item.qty}}` : '';
              const notesText = item.notes ? ` -- ${item.notes}` : '';
              const checkbox = item.have ? '‚úÖ' : '||‚úÖ||';
              
              md += `* ${checkbox} ${itemName}${qtyText}${aisleText}${notesText}${mealTags}\n`;
          });
        }
    }
  });

  document.getElementById("markdown-output").textContent = md.trim();
  
  // Show the copy button and preview toggle after generating markdown
  document.getElementById("copy-markdown-btn").style.display = "inline-block";
  document.getElementById("preview-toggle-container").style.display = "block";
  
  // Update preview if already in preview mode
  const previewToggle = document.getElementById("preview-mode-toggle");
  if (previewToggle.checked) {
    renderMarkdownPreview(md.trim());
  }
};

// Render markdown as HTML
function renderMarkdownPreview(markdown) {
  const previewDiv = document.getElementById("markdown-preview");
  
  // Simple markdown parser for our specific format
  let html = '';
  const lines = markdown.split('\n');
  let inList = false;
  let currentCategory = '';
  
  lines.forEach(line => {
    const trimmed = line.trim();
    
    if (trimmed.startsWith('# ')) {
      // H1 heading
      if (inList) {
        html += '</ul>';
        inList = false;
      }
      html += `<h1>${trimmed.substring(2)}</h1>`;
    } else if (trimmed.startsWith('## ')) {
      // H2 heading (category)
      if (inList) {
        html += '</ul>';
      }
      currentCategory = trimmed.substring(3);
      html += `<h2>${currentCategory}</h2><ul>`;
      inList = true;
    } else if (trimmed.startsWith('* ') || trimmed.startsWith('- ')) {
      // List item
      if (!inList) {
        html += '<ul>';
        inList = true;
      }
      let content = trimmed.substring(2);
      
      // Convert checkbox markers to actual checkboxes
      if (content.startsWith('‚úÖ ')) {
        // Already checked item - remove the ‚úÖ emoji and space
        const itemText = content.replace(/^‚úÖ\s+/, '');
        content = `<input type="checkbox" checked> <span>${itemText}</span>`;
      } else if (content.startsWith('||‚úÖ|| ')) {
        // Unchecked item - remove the ||‚úÖ|| marker and space
        const itemText = content.replace(/^\|\|‚úÖ\|\|\s+/, '');
        content = `<input type="checkbox"> <span>${itemText}</span>`;
      }
      
      html += `<li>${content}</li>`;
    } else if (trimmed.startsWith('_') && trimmed.endsWith('_')) {
      // Italic paragraph
      if (inList) {
        html += '</ul>';
        inList = false;
      }
      html += `<p>${trimmed.substring(1, trimmed.length - 1)}</p>`;
    } else if (trimmed === '') {
      // Empty line - close list if open
      if (inList) {
        html += '</ul>';
        inList = false;
      }
    } else if (trimmed) {
      // Regular paragraph
      if (inList) {
        html += '</ul>';
        inList = false;
      }
      html += `<p>${trimmed}</p>`;
    }
  });
  
  if (inList) {
    html += '</ul>';
  }
  
  previewDiv.innerHTML = html;
}

// Preview mode toggle
document.getElementById("preview-mode-toggle").addEventListener("change", (e) => {
  const previewDiv = document.getElementById("markdown-preview");
  const codeOutput = document.getElementById("markdown-output");
  const label = document.getElementById("preview-mode-label");
  
  if (e.target.checked) {
    // Switch to rendered view
    const markdown = codeOutput.textContent;
    renderMarkdownPreview(markdown);
    codeOutput.style.display = "none";
    previewDiv.style.display = "block";
    label.textContent = "Rendered";
  } else {
    // Switch to code view
    codeOutput.style.display = "block";
    previewDiv.style.display = "none";
    label.textContent = "Code";
  }
});

// Copy markdown to clipboard
document.getElementById("copy-markdown-btn").onclick = () => {
  const markdownText = document.getElementById("markdown-output").textContent;
  
  if (!markdownText || markdownText.trim() === "") {
    alert("No shopping list to copy. Please generate a list first.");
    return;
  }
  
  // Use the Clipboard API
  navigator.clipboard.writeText(markdownText).then(() => {
    // Show success feedback
    const btn = document.getElementById("copy-markdown-btn");
    const originalText = btn.textContent;
    btn.textContent = "‚úì Copied!";
    btn.style.background = "#4caf50";
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = "";
    }, 2000);
  }).catch(err => {
    // Fallback for older browsers
    const textArea = document.createElement("textarea");
    textArea.value = markdownText;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
      document.execCommand('copy');
      const btn = document.getElementById("copy-markdown-btn");
      const originalText = btn.textContent;
      btn.textContent = "‚úì Copied!";
      btn.style.background = "#4caf50";
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 2000);
    } catch (err) {
      alert("Failed to copy to clipboard. Please select and copy manually.");
    }
    
    document.body.removeChild(textArea);
  });
};

// --- SETTINGS TAB ---

document.getElementById("export-btn").onclick = () => {
  const data = JSON.stringify({ meals, weeklyPlan, oneOffItems, allOneOffItemsMaster, categories: CATEGORIES }, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);

  // --- New Filename Logic ---
  const versionInput = document.getElementById("export-version").value.trim();
  // Sanitize by removing characters not allowed in filenames
  const sanitizedVersion = versionInput.replace(/[\\/:"*?<>|]/g, ''); 
  
  const date = new Date();
  const year = date.getFullYear();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  const dateString = `${year}-${month}-${day}`;
  
  let filename = "SOUS-List_";
  if (sanitizedVersion) {
    filename += `${sanitizedVersion}_`;
  }
  filename += `${dateString}.json`;
  
  a.download = filename;
  // --- End New Filename Logic ---
  
  a.click();
  URL.revokeObjectURL(a.href); // Clean up
};

document.getElementById("import-file").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
        const data = JSON.parse(evt.target.result);
        if (data.meals) meals = data.meals;
        if (data.weeklyPlan) weeklyPlan = data.weeklyPlan;
        if (data.oneOffItems) oneOffItems = data.oneOffItems;
        if (data.allOneOffItemsMaster) allOneOffItemsMaster = data.allOneOffItemsMaster;
        if (data.categories) CATEGORIES = data.categories;
        
        saveData();
        updateAllIngredientNames();
        populateQuickAddDropdown();
        renderMeals();
        renderPlanner();
        renderOneOffItems();
        renderCategories();
        renderItems();
        populateCustomCategoryDropdown();
        alert("Data imported successfully!");
    } catch (err) {
        alert("Error importing file. It may be corrupt.\n" + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = null; // Clear file input
};

document.getElementById("reset-btn").onclick = () => {
    if (confirm("Are you sure you want to clear ALL data? This will delete all your saved meals and plans and cannot be undone.")) {
        localStorage.clear();
        location.reload();
    }
};

// --- OPTIONS ---

const includeHaveItemsToggle = document.getElementById("include-have-items-toggle");
const includeHaveItems = localStorage.getItem("includeHaveItems");

// Apply saved preference (default is true if not set)
if (includeHaveItems === "false") {
  includeHaveItemsToggle.checked = false;
} else {
  includeHaveItemsToggle.checked = true;
  if (includeHaveItems === null) {
    localStorage.setItem("includeHaveItems", "true");
  }
}

// Toggle include have items
includeHaveItemsToggle.addEventListener("change", () => {
  localStorage.setItem("includeHaveItems", includeHaveItemsToggle.checked.toString());
});

// --- DARK MODE ---

const darkModeToggle = document.getElementById("dark-mode-toggle");
const isDarkMode = localStorage.getItem("darkMode") === "true";

// Apply saved dark mode preference
if (isDarkMode) {
  document.body.classList.add("dark-mode");
  darkModeToggle.checked = true;
}

// Toggle dark mode
darkModeToggle.addEventListener("change", () => {
  if (darkModeToggle.checked) {
    document.body.classList.add("dark-mode");
    localStorage.setItem("darkMode", "true");
  } else {
    document.body.classList.remove("dark-mode");
    localStorage.setItem("darkMode", "false");
  }
});

// --- NAVIGATION ---

function switchTab(tab) {
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById(tab).style.display = "block";
  document.getElementById("tab-" + tab).classList.add("active");
}

document.getElementById("tab-planner").onclick = () => switchTab("planner");
document.getElementById("tab-dictionary").onclick = () => switchTab("dictionary");
document.getElementById("tab-settings").onclick = () => switchTab("settings");

// --- INITIALIZE APP ---

updateAllIngredientNames();
populateQuickAddDropdown();
populateCustomCategoryDropdown();
renderMeals();
renderPlanner();
renderOneOffItems();
renderCategories();
renderItems();

// Set initial tab to Weekly Planner
switchTab("planner");
</script>
</body>
</html>